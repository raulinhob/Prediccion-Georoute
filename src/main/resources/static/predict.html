<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Predicción de Mantenimiento - Dashboard</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"/>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        .card-custom {
            border-radius: 1rem;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .btn-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
        }
        .btn-custom:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            color: white;
        }
        .text-primary-custom {
            color: #667eea !important;
        }
        .bg-primary-custom {
            background-color: #667eea !important;
        }
        .bg-secondary-custom {
            background-color: #764ba2 !important;
        }
        .animate-fade-in {
            animation: fadeIn 0.35s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(6px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="text-dark">

<header class="py-4 d-flex align-items-center justify-content-between px-4">
    <div class="text-white">
        <h1 class="h3 fw-bold d-flex align-items-center gap-3"><i class="fas fa-bus"></i> Georoute - Predicción</h1>
        <p class="small opacity-75">Registra predicciones y consulta el historial guardado en MongoDB</p>
    </div>
    <button id="historyBtn" class="btn btn-light text-primary-custom fw-semibold rounded-pill shadow">
        <i class="fas fa-clipboard-list"></i> Historial
    </button>
</header>

<main class="d-flex align-items-start justify-content-center px-4 pb-5">
    <section class="card card-custom w-100" style="max-width: 1200px;">
        <div class="card-body p-4">
            <h2 class="h4 fw-bold text-primary-custom mb-4">Formulario de Predicción</h2>

            <!-- Formulario -->
            <form id="predictForm" class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-tachometer"></i></span>
                        <input name="mileage" placeholder="Kilometraje (ej. 50000)" required class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-wrench"></i></span>
                        <select name="maintenanceHistory" required class="form-select">
                            <option value="">Historial mantenimiento</option>
                            <option value="Poor">Poor</option>
                            <option value="Average">Average</option>
                            <option value="Good">Good</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-exclamation-triangle"></i></span>
                        <input name="reportedIssues" placeholder="Problemas reportados (ej. 2)" required class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-calendar-alt"></i></span>
                        <input name="vehicleAge" placeholder="Antigüedad años" required class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-gas-pump"></i></span>
                        <select name="fuelType" required class="form-select">
                            <option value="">Tipo Combustible</option>
                            <option value="Petrol">Petrol</option>
                            <option value="Diesel">Diesel</option>
                            <option value="Electric">Electric</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-cogs"></i></span>
                        <select name="transmissionType" required class="form-select">
                            <option value="">Transmisión</option>
                            <option value="Manual">Manual</option>
                            <option value="Automatic">Automatic</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-cog"></i></span>
                        <input name="engineSize" placeholder="Tamaño motor (L)" class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-calendar-check"></i></span>
                        <input name="lastServiceDate" placeholder="Último servicio (año)" class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-history"></i></span>
                        <input name="serviceHistory" placeholder="Historial de servicios (ej. 10)" class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-car-crash"></i></span>
                        <input name="accidentHistory" placeholder="Historial de accidentes (ej. 0)" class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-chart-line"></i></span>
                        <input name="fuelEfficiency" placeholder="Eficiencia km/L (ej. 15.5)" class="form-control" />
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-circle-notch"></i></span>
                        <select name="tireCondition" required class="form-select">
                            <option value="">Condición de llantas</option>
                            <option value="New">New</option>
                            <option value="Good">Good</option>
                            <option value="Worn Out">Worn Out</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-stop-circle"></i></span>
                        <select name="brakeCondition" required class="form-select">
                            <option value="">Condición de frenos</option>
                            <option value="Good">Good</option>
                            <option value="Worn Out">Worn Out</option>
                            <option value="New">New</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="fas fa-battery-half"></i></span>
                        <select name="batteryStatus" required class="form-select">
                            <option value="">Estado batería</option>
                            <option value="Good">Good</option>
                            <option value="Weak">Weak</option>
                            <option value="New">New</option>
                        </select>
                    </div>
                </div>
            </form>

            <!-- Botón -->
            <div class="mt-4 d-flex gap-3 align-items-center">
                <button id="submitBtn" class="btn btn-custom fw-bold shadow">
                    <i class="fas fa-magic me-2"></i>Predecir
                </button>
                <div id="loading" class="d-none d-flex align-items-center gap-2 small text-muted">
                    <i class="fas fa-spinner fa-spin"></i> Procesando...
                </div>
            </div>

            <!-- Resultado -->
            <div id="resultBox" class="mt-4 d-none p-3 rounded fw-semibold text-white"></div>
        </div>
    </section>
</main>

<!-- Modal Historial -->
<div class="modal fade" id="historyModal" tabindex="-1" aria-labelledby="historyModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-primary-custom fw-bold" id="historyModalLabel"><i class="fas fa-clipboard-list me-2"></i>Historial de Predicciones</h5>
                <div class="d-flex align-items-center gap-3">
                    <button id="clearBtn" class="btn btn-link text-danger p-0 small">Limpiar todo</button>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
            </div>
            <div class="modal-body" id="historyList">
                <!-- Aquí se inyectan los reportes -->
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    const API = "http://localhost:8080/api";
    const form = document.getElementById('predictForm');
    const submitBtn = document.getElementById('submitBtn');
    const loading = document.getElementById('loading');
    const resultBox = document.getElementById('resultBox');

    // modal
    const historyBtn = document.getElementById('historyBtn');
    const historyModal = new bootstrap.Modal(document.getElementById('historyModal'));
    const historyList = document.getElementById('historyList');
    const clearBtn = document.getElementById('clearBtn');

    // POST prediction -> save report
    submitBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      // validar
      const raw = Object.fromEntries(new FormData(form).entries());

      // Convierte algunos campos a número donde aplique
      const payload = {
        mileage: raw.mileage ? Number(raw.mileage) : null,
        maintenanceHistory: raw.maintenanceHistory || null,
        reportedIssues: raw.reportedIssues ? Number(raw.reportedIssues) : null,
        vehicleAge: raw.vehicleAge ? Number(raw.vehicleAge) : null,
        fuelType: raw.fuelType || null,
        transmissionType: raw.transmissionType || null,
        engineSize: raw.engineSize ? Number(raw.engineSize) : null,
        lastServiceDate: raw.lastServiceDate ? Number(raw.lastServiceDate) : null,
        serviceHistory: raw.serviceHistory ? Number(raw.serviceHistory) : null,
        accidentHistory: raw.accidentHistory ? Number(raw.accidentHistory) : null,
        fuelEfficiency: raw.fuelEfficiency ? Number(raw.fuelEfficiency) : null,
        tireCondition: raw.tireCondition || null,
        brakeCondition: raw.brakeCondition || null,
        batteryStatus: raw.batteryStatus || null
      };

      // simple front validation
      for (const k of Object.keys(payload)) {
        if (payload[k] === null || payload[k] === "") {
          alert("Completa todos los campos antes de predecir.");
          return;
        }
      }

      loading.classList.remove('d-none');
      submitBtn.disabled = true;
      resultBox.classList.add('d-none');

      try {
        // 1) pedir predicción al backend Weka
        const res = await fetch(`${API}/predict`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        const json = await res.json();
        const prediction = json.prediction ? json.prediction.trim() : 'Unknown';

        // 2) crear reporte completo y guardarlo en /reports
        const report = {
          ...payload,
          prediction,
          timestamp: new Date().toISOString(),
          // si quieres precisión real, cambia aquí; por ahora generamos un valor simulado frontend (puedes cambiarlo)
          accuracy: (Math.random() * (99 - 85) + 85).toFixed(2) + '%'
        };

        await fetch(`${API}/reports`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(report)
        });

        // 3) mostrar resultado en UI
        resultBox.classList.remove('d-none');
        if (prediction === 'Yes') {
          resultBox.className = 'mt-4 p-3 rounded fw-semibold text-white bg-danger';
          resultBox.textContent = '⚠️ El bus requiere mantenimiento (predicción: Yes)';
        } else if (prediction === 'No') {
          resultBox.className = 'mt-4 p-3 rounded fw-semibold text-white bg-success';
          resultBox.textContent = '✅ El bus NO requiere mantenimiento (predicción: No)';
        } else {
          resultBox.className = 'mt-4 p-3 rounded fw-semibold text-white bg-secondary';
          resultBox.textContent = `❓ Resultado no claro: ${prediction}`;
        }

      } catch (err) {
        console.error(err);
        resultBox.classList.remove('d-none');
        resultBox.className = 'mt-4 p-3 rounded fw-semibold text-white bg-danger';
        resultBox.textContent = '❌ Error al pedir predicción o guardar reporte.';
      } finally {
        loading.classList.add('d-none');
        submitBtn.disabled = false;
      }
    });

    // abrir modal y cargar historial
    historyBtn.addEventListener('click', async () => {
      historyModal.show();
      historyList.innerHTML = '<div class="text-center py-4">Cargando... <i class="fas fa-spinner fa-spin"></i></div>';
      try {
        const res = await fetch(`${API}/reports`);
        const data = await res.json();
        if (!data || data.length === 0) {
          historyList.innerHTML = '<p class="text-center text-muted py-4">No hay reportes.</p>';
          return;
        }
        // render
        historyList.innerHTML = '';
        data.slice().reverse().forEach(r => {
          historyList.innerHTML += `
            <div class="p-3 rounded border shadow-sm d-flex gap-3 align-items-start justify-content-between animate-fade-in">
              <div class="flex-fill">
                <div class="d-flex align-items-center gap-3">
                  <div class="small fw-bold ${r.prediction === 'Yes'? 'text-danger' : 'text-success'}">
                    ${r.prediction === 'Yes' ? '<i class="fas fa-exclamation-triangle"></i> Requiere mantenimiento' : '<i class="fas fa-check-circle"></i> Buen estado'}
                  </div>
                  <div class="small text-muted ms-2">${new Date(r.timestamp).toLocaleString()}</div>
                </div>
                <div class="mt-2 small text-muted">
                  <div><strong>Kilometraje:</strong> ${r.mileage} km — <strong>FuelEff:</strong> ${r.fuelEfficiency} km/L — <strong>Motor:</strong> ${r.engineSize} L</div>
                  <div><strong>Mantenimiento:</strong> ${r.maintenanceHistory} — <strong>ServiceCount:</strong> ${r.serviceHistory} — <strong>Accidentes:</strong> ${r.accidentHistory}</div>
                  <div><strong>Combustible:</strong> ${r.fuelType} — <strong>Transmisión:</strong> ${r.transmissionType}</div>
                  <div><strong>Llantas:</strong> ${r.tireCondition} — <strong>Frenos:</strong> ${r.brakeCondition} — <strong>Batería:</strong> ${r.batteryStatus}</div>
                </div>
              </div>
              <div class="text-end">
                <div class="small text-muted mt-2">ID: ${r.id || ''}</div>
                <div class="mt-3 d-flex gap-2 justify-content-end">
                  <button class="deleteBtn btn btn-link text-danger p-0 small" data-id="${r.id}">Borrar</button>
                </div>
              </div>
            </div>
          `;
        });

        // attach delete handlers
        document.querySelectorAll('.deleteBtn').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.dataset.id;
            if (!confirm('Borrar este reporte?')) return;
            try {
              await fetch(`${API}/reports/${id}`, { method: 'DELETE' });
              btn.closest('.d-flex')?.remove(); // fallback
              // reload list:
              historyBtn.click();
            } catch (e) { alert('Error borrando'); }
          });
        });

      } catch (err) {
        historyList.innerHTML = '<p class="text-danger text-center py-4">Error cargando historial.</p>';
      }
    });

    // Clear all
    clearBtn.addEventListener('click', async () => {
      if (!confirm('Borrar todo el historial?')) return;
      try {
        await fetch(`${API}/reports/clear`, { method: 'DELETE' });
        historyList.innerHTML = '<p class="text-center text-muted py-4">Historial vacío.</p>';
      } catch (e) { alert('Error al limpiar historial.'); }
    });

</script>
</body>
</html>